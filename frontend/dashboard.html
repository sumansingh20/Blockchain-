<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Energy Trade | NIT Jalandhar</title>
    <meta name="description" content="Blockchain-based Campus Energy Trading System with CBDC Settlement">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-text p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 9999px;
            font-size: 0.875rem;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Layout */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card:nth-child(1)::before { background: var(--gradient-3); }
        .stat-card:nth-child(2)::before { background: var(--gradient-1); }
        .stat-card:nth-child(3)::before { background: var(--success); }
        .stat-card:nth-child(4)::before { background: var(--gradient-2); }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-card:nth-child(1) .stat-icon { background: rgba(79, 172, 254, 0.15); }
        .stat-card:nth-child(2) .stat-icon { background: rgba(102, 126, 234, 0.15); }
        .stat-card:nth-child(3) .stat-icon { background: rgba(16, 185, 129, 0.15); }
        .stat-card:nth-child(4) .stat-icon { background: rgba(245, 87, 108, 0.15); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
        }

        /* Transactions Table */
        .transactions-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .transaction-item:hover {
            background: var(--bg-hover);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .tx-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .tx-icon.receipt { background: rgba(79, 172, 254, 0.15); }
        .tx-icon.token { background: rgba(245, 158, 11, 0.15); }
        .tx-icon.settlement { background: rgba(16, 185, 129, 0.15); }

        .tx-details h4 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .tx-details p {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .tx-amount {
            text-align: right;
        }

        .tx-amount .value {
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .tx-amount .label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Wallet List */
        .wallet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .wallet-item:last-child {
            border-bottom: none;
        }

        .wallet-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .wallet-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: var(--bg-dark);
        }

        .wallet-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .wallet-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .wallet-balance {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--success);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tariff Info */
        .tariff-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .tariff-item {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .tariff-period {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .tariff-rate {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .tariff-item.active {
            border: 2px solid var(--primary);
        }

        .tariff-item.active .tariff-rate {
            color: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div class="logo-text">
                    <h1>Campus Energy Trade</h1>
                    <p>Dr B R Ambedkar NIT Jalandhar</p>
                </div>
            </div>
            <div class="status-badge" id="statusBadge">
                <span class="status-dot"></span>
                <span>Blockchain Connected</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Stats Grid -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="statReceipts">0</div>
                <div class="stat-label">Energy Receipts</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ü™ô</div>
                <div class="stat-value" id="statTokens">0</div>
                <div class="stat-label">Tokens Minted</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-value" id="statEnergy">0 kWh</div>
                <div class="stat-label">Total Energy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="statSettlement">‚Çπ0</div>
                <div class="stat-label">CBDC Settled</div>
            </div>
        </section>

        <!-- Content Grid -->
        <section class="content-grid">
            <!-- Transaction Form & History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìù New Energy Transaction</h2>
                </div>
                <div class="card-body">
                    <form id="transactionForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Meter ID</label>
                                <select class="form-select" id="meterId" required>
                                    <option value="">Select meter...</option>
                                    <optgroup label="üè† Hostels">
                                        <option value="NITJ-MH1-001">NITJ-MH1-001 - Mega Hostel Block-1</option>
                                        <option value="NITJ-MH2-002">NITJ-MH2-002 - Mega Hostel Block-2</option>
                                        <option value="NITJ-GH1-003">NITJ-GH1-003 - Girls Hostel</option>
                                    </optgroup>
                                    <optgroup label="üéì Academic">
                                        <option value="NITJ-MB1-004">NITJ-MB1-004 - Main Building</option>
                                        <option value="NITJ-LH1-005">NITJ-LH1-005 - Lecture Hall</option>
                                        <option value="NITJ-CS1-006">NITJ-CS1-006 - CS Block</option>
                                        <option value="NITJ-ECE-007">NITJ-ECE-007 - ECE Dept</option>
                                        <option value="NITJ-ME1-008">NITJ-ME1-008 - Mechanical</option>
                                    </optgroup>
                                    <optgroup label="üèõÔ∏è Administrative">
                                        <option value="NITJ-ADM-009">NITJ-ADM-009 - Admin Block</option>
                                        <option value="NITJ-LIB-010">NITJ-LIB-010 - Library</option>
                                    </optgroup>
                                    <optgroup label="‚öôÔ∏è Facilities">
                                        <option value="NITJ-SPT-011">NITJ-SPT-011 - Sports Complex</option>
                                        <option value="NITJ-WKS-012">NITJ-WKS-012 - Workshop</option>
                                        <option value="NITJ-CAF-015">NITJ-CAF-015 - Cafeteria</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Energy (kWh)</label>
                                <input type="number" class="form-input" id="kWh" placeholder="e.g., 25.5" 
                                       step="0.001" min="0.001" max="1000" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Carbon Tag</label>
                                <select class="form-select" id="carbonTag">
                                    <option value="NORMAL">NORMAL - Grid Power</option>
                                    <option value="GREEN">GREEN - Low Carbon</option>
                                    <option value="RENEWABLE">RENEWABLE - Solar/Wind</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payer Wallet</label>
                                <select class="form-select" id="payerWallet">
                                    <option value="NITJ_MAIN">NITJ_MAIN - Main Account</option>
                                    <option value="NITJ_HOSTELS">NITJ_HOSTELS - Hostels</option>
                                    <option value="NITJ_ACADEMIC">NITJ_ACADEMIC - Academic</option>
                                    <option value="NITJ_SPORTS">NITJ_SPORTS - Sports</option>
                                    <option value="NITJ_WORKSHOP">NITJ_WORKSHOP - Workshop</option>
                                    <option value="NITJ_LIBRARY">NITJ_LIBRARY - Library</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                            ‚ö° Record & Settle Transaction
                        </button>
                    </form>

                    <!-- Tariff Info -->
                    <div style="margin-top: 1.5rem;">
                        <div class="form-label" style="margin-bottom: 0.75rem;">üìä PSPCL Tariff Rates</div>
                        <div class="tariff-grid" id="tariffGrid">
                            <div class="tariff-item" id="tariffNormal">
                                <div class="tariff-period">NORMAL (6AM-6PM)</div>
                                <div class="tariff-rate">‚Çπ6.79/kWh</div>
                            </div>
                            <div class="tariff-item" id="tariffPeak">
                                <div class="tariff-period">PEAK (6PM-10PM)</div>
                                <div class="tariff-rate">‚Çπ8.15/kWh</div>
                            </div>
                            <div class="tariff-item" id="tariffOffPeak">
                                <div class="tariff-period">OFF-PEAK (10PM-6AM)</div>
                                <div class="tariff-rate">‚Çπ6.11/kWh</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="card-header" style="border-top: 1px solid var(--border);">
                    <h2 class="card-title">üìú Recent Transactions</h2>
                </div>
                <div class="transactions-container" id="transactionsContainer">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">üìä</div>
                        <p>No transactions yet. Submit your first energy reading above!</p>
                    </div>
                </div>
            </div>

            <!-- Wallets Panel -->
            <div>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h2 class="card-title">üí≥ CBDC (e‚Çπ) Wallets</h2>
                        <button class="btn btn-primary" onclick="refreshWallets()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="walletsContainer">
                        <!-- Wallets will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üèõÔ∏è Institution Details</h2>
                    </div>
                    <div class="card-body">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            <p style="margin-bottom: 0.75rem;">
                                <strong>Institution:</strong> Dr B R Ambedkar NIT Jalandhar
                            </p>
                            <p style="margin-bottom: 0.75rem;">
                                <strong>Project:</strong> Final Year B.Tech Project
                            </p>
                            <p style="margin-bottom: 0.75rem;">
                                <strong>Standard:</strong> IS-15959:2011 Smart Metering
                            </p>
                            <p style="margin-bottom: 0.75rem;">
                                <strong>Utility:</strong> PSPCL Punjab Tariff 2024
                            </p>
                            <p>
                                <strong>Settlement:</strong> RBI Digital Rupee (e‚Çπ) Pilot
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Configuration
        const API_URL = '/api';
        let transactions = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadStatistics();
            refreshWallets();
            loadRecentTransactions();
            updateTariffHighlight();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadStatistics();
                refreshWallets();
                loadRecentTransactions();
            }, 30000);
        });

        // Load recent transactions from blockchain
        async function loadRecentTransactions() {
            try {
                const response = await fetch(`${API_URL}/transactions/recent?limit=20`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    transactions = data.data;
                    renderTransactions();
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        // Check server health
        async function checkHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                const badge = document.getElementById('statusBadge');
                if (data.status === 'healthy') {
                    badge.innerHTML = '<span class="status-dot"></span><span>Blockchain Connected</span>';
                    badge.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                    badge.style.color = 'var(--success)';
                } else {
                    badge.innerHTML = '<span class="status-dot" style="background: var(--warning)"></span><span>Limited Mode</span>';
                    badge.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                    badge.style.color = 'var(--warning)';
                }
            } catch (error) {
                const badge = document.getElementById('statusBadge');
                badge.innerHTML = '<span class="status-dot" style="background: var(--danger)"></span><span>Disconnected</span>';
                badge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                badge.style.color = 'var(--danger)';
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_URL}/statistics`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    // Handle both old (blockchain) and new (flat) formats
                    const receipts = stats.blockchain?.receipts || stats.totalTransactions || 0;
                    const tokens = stats.blockchain?.tokens || stats.totalTransactions || 0;
                    const totalEnergy = stats.blockchain?.totalEnergy || stats.totalEnergy || 0;
                    const settlementValue = stats.blockchain?.settlementValue || parseFloat(stats.totalSettled) || 0;
                    
                    document.getElementById('statReceipts').textContent = receipts;
                    document.getElementById('statTokens').textContent = tokens;
                    document.getElementById('statEnergy').textContent = `${parseFloat(totalEnergy).toFixed(1)} kWh`;
                    document.getElementById('statSettlement').textContent = `‚Çπ${parseFloat(settlementValue).toLocaleString('en-IN')}`;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        // Refresh wallets
        async function refreshWallets() {
            try {
                const response = await fetch(`${API_URL}/wallet/all`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('walletsContainer');
                    let wallets = data.data;
                    
                    // Handle array format (from API) - convert to object for display
                    if (Array.isArray(wallets)) {
                        const walletsObj = {};
                        wallets.forEach(w => {
                            walletsObj[w.id] = { name: w.name, balance: w.balance, type: w.type };
                        });
                        wallets = walletsObj;
                    }
                    
                    const walletIcons = {
                        'NITJ_MAIN': 'üèõÔ∏è',
                        'NITJ_HOSTELS': 'üè†',
                        'NITJ_ACADEMIC': 'üéì',
                        'NITJ_SPORTS': '‚öΩ',
                        'NITJ_WORKSHOP': '‚öôÔ∏è',
                        'NITJ_LIBRARY': 'üìö',
                        'NITJ_ADMIN': 'üìã',
                        'NITJ_SOLAR': '‚òÄÔ∏è',
                        'NITJ_MICRO_GEN': 'üîã',
                        'NITJ_EV_CHARGER': 'üöó',
                        'NITJ_RESEARCH': 'üî¨',
                        'NITJ_TREASURY': 'üè¶',
                        'PARTNER_BANK': 'üèß',
                        'PSPCL_GRID': '‚ö°',
                        'RBI_ESCROW': 'üèõÔ∏è'
                    };
                    
                    container.innerHTML = Object.entries(wallets)
                        .filter(([id]) => id !== 'RBI_ESCROW')
                        .map(([id, info]) => `
                            <div class="wallet-item">
                                <div class="wallet-info">
                                    <div class="wallet-avatar">${walletIcons[id] || 'üí∞'}</div>
                                    <div>
                                        <div class="wallet-name">${info.name || id}</div>
                                        <div class="wallet-id">${info.type || 'e‚Çπ-R Retail'}</div>
                                    </div>
                                </div>
                                <div class="wallet-balance">‚Çπ${parseFloat(info.balance).toLocaleString('en-IN', { minimumFractionDigits: 2 })}</div>
                            </div>
                        `).join('');
                }
            } catch (error) {
                console.error('Failed to load wallets:', error);
            }
        }

        // Update tariff highlight based on current time
        function updateTariffHighlight() {
            const hour = new Date().getHours();
            
            document.querySelectorAll('.tariff-item').forEach(el => el.classList.remove('active'));
            
            if (hour >= 18 && hour < 22) {
                document.getElementById('tariffPeak').classList.add('active');
            } else if (hour >= 22 || hour < 6) {
                document.getElementById('tariffOffPeak').classList.add('active');
            } else {
                document.getElementById('tariffNormal').classList.add('active');
            }
        }

        // Handle form submission
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
            submitBtn.disabled = true;
            
            try {
                const formData = {
                    meterId: document.getElementById('meterId').value,
                    kWh: parseFloat(document.getElementById('kWh').value),
                    carbonTag: document.getElementById('carbonTag').value,
                    payerWallet: document.getElementById('payerWallet').value,
                    payeeWallet: 'PSPCL_GRID'
                };
                
                const response = await fetch(`${API_URL}/transaction/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('success', `Transaction successful! Receipt #${data.data.receipt.receiptId} | ‚Çπ${data.data.pricing.total.toFixed(2)}`);
                    addTransaction(data.data);
                    loadStatistics();
                    refreshWallets();
                    
                    // Reset form
                    document.getElementById('kWh').value = '';
                } else {
                    showToast('error', data.error || 'Transaction failed');
                }
            } catch (error) {
                showToast('error', 'Server error: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Add transaction to list
        function addTransaction(data) {
            transactions.unshift(data);
            renderTransactions();
        }

        // Render transactions
        function renderTransactions() {
            const container = document.getElementById('transactionsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (transactions.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            const carbonIcons = {
                'GREEN': 'üåø',
                'RENEWABLE': '‚òÄÔ∏è',
                'NORMAL': '‚ö°',
                'CERTIFIED': '‚úÖ'
            };
            
            container.innerHTML = transactions.slice(0, 20).map(tx => {
                const receiptId = tx.receipt?.receiptId || tx.receipt?.id || '?';
                const tokenId = tx.token?.tokenId || tx.token?.id || '?';
                const settlementId = tx.settlement?.settlementId || tx.settlement?.id || '?';
                const meterId = tx.summary?.meterId || tx.receipt?.meterId || 'Unknown';
                const carbonTag = tx.summary?.carbonTag || tx.receipt?.carbonTag || 'NORMAL';
                const kWh = tx.summary?.kWh || tx.receipt?.kWh || 0;
                const total = tx.pricing?.total || 0;
                const icon = carbonIcons[carbonTag] || '‚ö°';
                
                return `
                    <div class="transaction-item">
                        <div class="tx-icon settlement">${icon}</div>
                        <div class="tx-details">
                            <h4>${meterId} - ${carbonTag}</h4>
                            <p>Receipt #${receiptId} ‚Üí Token #${tokenId} ‚Üí Settlement #${settlementId}</p>
                        </div>
                        <div class="tx-amount">
                            <div class="value">‚Çπ${total.toFixed(2)}</div>
                            <div class="label">${parseFloat(kWh).toFixed(3)} kWh</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show toast notification
        function showToast(type, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Update tariff highlight every minute
        setInterval(updateTariffHighlight, 60000);
    </script>
</body>
</html>
